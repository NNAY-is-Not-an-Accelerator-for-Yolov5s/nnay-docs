# 指令集架构概述

## NNAY 指令集简介

NNAY指令集是一套专门设计用于加速神经网络推理，特别是YOLOv5目标检测模型的指令集架构。该指令集通过优化计算密集型操作（如卷积、池化和激活函数）来提高模型执行效率，减少延迟并降低功耗。

NNAY指令集的每条指令可能由多个指令块(Instruction Block)组成，每个指令块固定为8字节。

## NNAY 指令集格式

NNAY 的每个指令长度不定，但均为8字节的整数倍。

对于每条指令的头8个字节，规定如下：

| 字段   | 长度 | 描述       |
| ------ | ---- | ---------- |
| [3:0]  | 4    | Opcode     |
| [7:4]  | 4    | Sub Opcode |
| [63:8] | 56   | 指令参数   |

## 指令

### ConvAct

用于执行卷积和激活函数。该指令长度为24字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述           | 值域   | 备注                 |
| ------- | ---- | -------------- | ------ | -------------------- |
| [3:0]   | 4    | Opcode         | 0x01   |                      |
| [7:4]   | 4    | Sub Opcode     | 0x01   |                      |
| [19:8]  | 12   | 输入通道数     | 0-4095 | 实际输入通道数-1     |
| [31:20] | 12   | 输出通道数     | 0-4095 | 实际输出通道数-1     |
| [43:32] | 12   | 输入特征图高度 | 0-4095 | 实际输入特征图高度-1 |
| [55:44] | 12   | 输入特征图宽度 | 0-4095 | 实际输入特征图宽度-1 |
| [59:56] | 4    | 卷积核高度     | 0-15   | 实际卷积核高度-1     |
| [63:60] | 4    | 卷积核宽度     | 0-15   | 实际卷积核宽度-1     |

#### Block 2

| 字段    | 长度 | 描述              | 值域 | 备注                   |
| ------- | ---- | ----------------- | ---- | ---------------------- |
| [3:0]   | 4    | 上方 Padding 长度 | 0-15 |                        |
| [7:4]   | 4    | 下方 Padding 长度 | 0-15 |                        |
| [11:8]  | 4    | 左侧 Padding 长度 | 0-15 |                        |
| [15:12] | 4    | 右侧 Padding 长度 | 0-15 |                        |
| [19:16] | 4    | 激活函数          | Enum | 0:None, 1:ReLu, 2:SiLU |
| [31:20] | 12   | Reserved          | --   |                        |
| [63:32] | 32   | 权重首地址        | -    |                        |

#### Block 3

| 字段    | 长度 | 描述             | 值域 | 备注 |
| ------- | ---- | ---------------- | ---- | ---- |
| [31:0]  | 32   | 输入特征图首地址 | -    |      |
| [63:32] | 32   | 输出特征图首地址 | -    |      |
