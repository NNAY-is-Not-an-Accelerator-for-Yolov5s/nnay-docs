# 指令定义

## 配置指令

### CONFBADDR(配置基地址)

用于配置基地址。该指令长度为8字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述            | 值域      | 备注                    |
| ------- | ---- | --------------- | --------- | ----------------------- |
| [3:0]   | 4    | Opcode          | 0b0000    |                         |
| [5:4]   | 2    | Funct           | 0b00      |                         |
| [10:6]  | 5    | 输入数据基地址1 | 0x00-0x1F | `Reg(InputBaseAddr.1)`  |
| [15:11] | 5    | 输入数据基地址2 | 0x00-0x1F | `Reg(InputBaseAddr.2)`  |
| [20:16] | 5    | 输出数据基地址1 | 0x00-0x1F | `Reg(OutputBaseAddr.1)` |
| [25:21] | 5    | 输出数据基地址2 | 0x00-0x1F | `Reg(OutputBaseAddr.2)` |
| [30:26] | 5    | 权重基地址      | 0x00-0x1F | `Reg(WeightBaseAddr)`   |
| [63:31] | 33   | Reserved        | -         |                         |

## 计算指令

### CONVACT(卷积激活)

用于执行卷积和激活函数。该指令长度为24字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述           | 值域   | 备注                         |
| ------- | ---- | -------------- | ------ | ---------------------------- |
| [3:0]   | 4    | Opcode         | 0b1001 |                              |
| [5:4]   | 2    | Funct          | 0b00   |                              |
| [12:6]  | 7    | 输入通道数     | 0-63   | $实际通道数=(值+1)\times 16$ |
| [19:13] | 7    | 输出通道数     | 0-63   | $实际通道数=(值+1)\times 16$ |
| [20:20] | 1    | 卷积核类型     | 0-1    | 0: 1x1, 1: 3x3               |
| [21:21] | 1    | 卷积核步长     | 1-2    | 步长=值+1                    |
| [22:22] | 1    | Padding 大小   | 0-3    |                              |
| [24:23] | 2    | 激活函数       | 0-3    | 0:None, 1:SiLU, 2:ReLu       |
| [25:25] | 1    | Split          | Bool   | False: 不分割, True: 分割    |
| [31:26] | 6    | Reserved       | -      |                              |
| [41:32] | 10   | 输入特征图高度 | 0-1023 | $实际高度=值+1$              |
| [51:42] | 10   | 输入特征图宽度 | 0-1023 | $实际宽度=值+1$              |
| [63:52] | 12   | Reserved       | -      |                              |

#### Block 2

| 字段    | 长度 | 描述                 | 值域 | 备注                        |
| ------- | ---- | -------------------- | ---- | --------------------------- |
| [7:0]   | 8    | Reserved             | -    |                             |
| [31:8]  | 24   | 输入特征图首地址偏移 | -    | Base=`Reg(InputBaseAddr.1)` |
| [55:32] | 24   | 权重首地址偏移       | -    | Base=`Reg(WeightBaseAddr)`  |
| [63:56] | 8    | Reserved             | -    |                             |

#### Block 3

| 字段    | 长度 | 描述                  | 值域 | 备注                                               |
| ------- | ---- | --------------------- | ---- | -------------------------------------------------- |
| [7:0]   | 8    | Reserved              | -    |                                                    |
| [23:0]  | 24   | 输出特征图首地址偏移1 | -    | Base=`Reg(OutputBaseAddr.1)`                       |
| [55:32] | 24   | 输出特征图首地址偏移2 | -    | Base=`Reg(OutputBaseAddr.2)`，仅当Split=True时有效 |
| [63:56] | 8    | Reserved              | -    |                                                    |

### ELADD(张量逐元素相加)

用于执行元素相加。该指令长度为8字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述                | 值域    | 备注                        |
| ------- | ---- | ------------------- | ------- | --------------------------- |
| [3:0]   | 4    | Opcode              | 0b01001 |                             |
| [5:4]   | 2    | Funct               | 0b00    |                             |
| [31:8]  | 24   | 输入张量1首地址偏移 | -       | Base=`Reg(InputBaseAddr.1)` |
| [55:32] | 24   | 输入张量2首地址偏移 | -       | Base=`Reg(InputBaseAddr.2)` |
| [63:56] | 8    | Reserved            | -       |                             |

### ELMUL(张量逐元素相乘)

用于执行张量逐元素相乘。

\[
    T_{out}^{MX}(i)=T_{in1}^{MX}(i)\times T_{in2}^{MX}(i), \forall i
\]

该指令长度为8字节，格式如下：

#### Block 1

| 字段  | 长度 | 描述   | 值域    | 备注 |
| ----- | ---- | ------ | ------- | ---- |
| [3:0] | 4    | Opcode | 0b01001 |      |
| [5:4] | 2    | Funct  | 0b01    |      |

### SMULI(标量立即数乘)

对张量指定立即数进行乘法运算。

\[
    T_{out}^{MX}(i) = T_{in}^{MX}(i) \times \text{Imm}, \forall i
\]

该指令长度为8字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述               | 值域   | 备注                        |
| ------- | ---- | ------------------ | ------ | --------------------------- |
| [3:0]   | 4    | Opcode             | 0b1010 |                             |
| [5:4]   | 2    | Funct              | 0b01   |                             |
| [21:6]  | 16   | 立即数             | -      | BF16                        |
| [31:22] | 10   | len1               | -      |                             |
| [55:32] | 24   | 输入张量首地址偏移 | -      | Base=`Reg(InputBaseAddr.1)` |
| [63:56] | 8    | len2               | -      |                             |

长度单位为 MX 块大小，对于 MX9，则为18 Byte。

len = len2 << 10 | len1，单次最大可操作范围为 2^18 Block = 256 KBlock。

#### Block 2

| 字段    | 长度 | 描述               | 值域 | 备注                         |
| ------- | ---- | ------------------ | ---- | ---------------------------- |
| [7:0]   | 8    | Reserved           | -    |                              |
| [31:8]  | 24   | 输出张量首地址偏移 | -    | Base=`Reg(OutputBaseAddr.1)` |
| [63:32] | 32   | Reserved           | -    |                              |

### POOL(池化)

### SIGMOID(Sigmoid)

用于执行Sigmoid激活函数。

\[
    T_{out}^{MX}(i)(j) = \frac{1}{1 + e^{-T_{in}^{MX}(i)(j)}}, j \in [0, 15]
\]

### SOFTMAX(Softmax)

!!! note
    该指令不在Yolov5s模型中出现。

对MX张量块进行Softmax操作。

\[
    T_{out}^{MX}(i)(j) = \frac{e^{T_{in}^{MX}(i)(j)}}{\sum_{k=0}^{15} e^{T_{in}^{MX}(i)(k)}}, j \in [0, 15]
\]
