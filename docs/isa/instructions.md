# 指令定义

## 配置指令

### ConfigMode

用于配置加速器模式。该指令长度为8字节，格式如下：

| 字段   | 长度 | 描述       | 值域      | 备注          |
| ------ | ---- | ---------- | --------- | ------------- |
| [1:0]  | 2    | Opcode     | 0b00      |               |
| [5:2]  | 4    | Sub Opcode | 0b0000    |               |
| [7:6]  | 2    | Funct      | 0b00      |               |
| [11:8] | 4    | MXMode     | 0x00-0x0F | `Reg(MXMode)` |
| [63:12] | 52   | Reserved   | -         |               |

### ConfigBaseAddr

用于配置基地址。该指令长度为8字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述           | 值域      | 备注                  |
| ------- | ---- | -------------- | --------- | --------------------- |
| [1:0]   | 2    | Opcode         | 0b00      |                       |
| [5:2]   | 4    | Sub Opcode     | 0b0001    |                       |
| [7:6]   | 2    | Funct          | 0b00      |                       |
| [12:8]  | 5    | 输入数据基地址 | 0x00-0x1F | `Reg(InputBaseAddr)`  |
| [17:13] | 5    | 输出数据基地址 | 0x00-0x1F | `Reg(OutputBaseAddr)` |
| [22:18] | 5    | 权重基地址     | 0x00-0x1F | `Reg(WeightBaseAddr)` |
| [63:23] | 41   | Reserved       | -         |                       |

## 计算指令

### ConvAct

用于执行卷积和激活函数。该指令长度为24字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述           | 值域   | 备注                 |
| ------- | ---- | -------------- | ------ | -------------------- |
| [1:0]   | 2    | Opcode         | 0b01   |                      |
| [5:2]   | 4    | Sub Opcode     | 0b0000 |                      |
| [7:6]   | 2    | Funct          | 0b00   |                      |
| [19:8]  | 12   | 输入通道数     | 0-4095 | 实际输入通道数-1     |
| [31:20] | 12   | 输出通道数     | 0-4095 | 实际输出通道数-1     |
| [43:32] | 12   | 输入特征图高度 | 0-4095 | 实际输入特征图高度-1 |
| [55:44] | 12   | 输入特征图宽度 | 0-4095 | 实际输入特征图宽度-1 |
| [59:56] | 4    | 卷积核高度     | 0-15   | 实际卷积核高度-1     |
| [63:60] | 4    | 卷积核宽度     | 0-15   | 实际卷积核宽度-1     |

#### Block 2

| 字段    | 长度 | 描述              | 值域 | 备注                   |
| ------- | ---- | ----------------- | ---- | ---------------------- |
| [3:0]   | 4    | 上方 Padding 长度 | 0-15 |                        |
| [7:4]   | 4    | 下方 Padding 长度 | 0-15 |                        |
| [11:8]  | 4    | 左侧 Padding 长度 | 0-15 |                        |
| [15:12] | 4    | 右侧 Padding 长度 | 0-15 |                        |
| [19:16] | 4    | 激活函数          | Enum | 0:None, 1:ReLu, 2:SiLU |
| [31:20] | 12   | Reserved          | -    |                        |
| [55:32] | 24   | 权重首地址偏移    | -    |                        |
| [63:56] | 8    | Reserved          | --   |                        |

#### Block 3

| 字段    | 长度 | 描述                 | 值域 | 备注 |
| ------- | ---- | -------------------- | ---- | ---- |
| [23:0]  | 24   | 输入特征图首地址偏移 | -    |      |
| [31:24] | 8    | Reserved             | -    |      |
| [55:32] | 24   | 输出特征图首地址偏移 | -    |      |
| [63:56] | 8    | Reserved             | -    |      |

### MX.ScalarMul.(ScalarType)

用于执行标量乘法。该指令长度为16字节，格式如下：

#### Block 1

| 字段    | 长度 | 描述         | 值域   | 备注                 |
| ------- | ---- | ------------ | ------ | -------------------- |
| [1:0]   | 2    | Opcode       | 0b01   |                      |
| [5:2]   | 4    | Sub Opcode   | 0b0001 |                      |
| [7:6]   | 2    | Funct        | -      | 0b00: BF16           |
| [15:8]  | 8    | len1         | -      | 输入长度part1        |
| [31:16] | 16   | 立即数       | -      | 立即数               |
| [55:32] | 24   | 输入张量偏移 | -      | 基地址使用输入基地址 |
| [63:56] | 8    | len2         | -      | 输入长度part2        |

总长度计算公式：
`len = len1[7:0] << 8 | len2[7:0]`，长度单位为MX Block。
Block的大小可以通过`Reg(MXMode)`的值域来确定。例如对于MX9，Block大小为18字节。

ScalarType 根据 Funct 的值域来确定。例如Funct=0b00，则指令为MX.ScalarMul.BF16。